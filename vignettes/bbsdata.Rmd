---
title: "Working with BBS data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Working with BBS data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)


library(birdsize)
library(dplyr)

```


# Downloading data using the data retriever

The `rdataretriever` package provides an interface for accessing the Breeding Bird Survey data. 

To install the retriever and use it to access BBS data, follow the instructions [here](https://docs.ropensci.org/rdataretriever/#basic-installation). For example:

```{r, eval = F}
install.packages('reticulate') # Install R package for interacting with Python
reticulate::install_miniconda() # Install Python
reticulate::py_install('retriever') # Install the Python retriever package
install.packages('rdataretriever') # Install the R package for running the retriever
rdataretriever::get_updates() # Update the available datasets

rdataretriever::install_sqlite("breed-bird-survey", file = "bbs.sqlite", data_dir = "../retriever_data")

library(DBI)

bbs_db <- dbConnect(RSQLite::SQLite(), '../../retriever_data/bbs.sqlite')

surveys <- dplyr::tbl(bbs_db, "breed_bird_survey_counts")
sites <- dplyr::tbl(bbs_db, "breed_bird_survey_routes")
species <- dplyr::tbl(bbs_db, "breed_bird_survey_species")

```

The `community_` functions operate on a single survey route. The `sites` table contains information about the location, data quality of survey routes. The following extracts the route for New Hartford, CT. 

```{r, eval = F}

filter(sites, statenum == 18, route == 102)

myroute <- surveys %>%
  filter(statenum == 18,
         route == 102) %>% # substitute the state number and 
  as.data.frame() 

DBI::dbDisconnect(bbs_db)

```
Synthetic data for a fictional route with the same column names and types are included in `birdsize` as `demo_route_raw`.

```{r, results = T}

demo_route_raw <- demo_route_raw

head(demo_route_raw)

```



# Cleaning data

Following Harris et al (2018) and convention, removing taxa not well captured by the BBS methodology (nightbirds, waterbirds) and unidentified species.

```{r}

demo_route_cleaned <- demo_route_raw %>%
  filter_bbs_survey()

```


For the New Hartford route, this removes `r nrow(demo_route_raw) - nrow(demo_route_cleaned)` records of `r length(unique(demo_route_raw$aou)) - length(unique(demo_route_cleaned$aou))` species.



